# CLI UX Improvements: JSON-First Design

**Date:** 2025-12-10
**Status:** ‚úÖ Implemented
**Scope:** CASCADE phase commands (preflight, postflight)

---

## Problem Statement

The original CLI had backwards output defaults:
- **Default:** Human-readable (interactive-focused)
- **Required flag:** `--json` (for programmatic use)

This is inverted for the actual use case:
- **AI and Sentinel use the CLI** (need JSON for programmatic composition)
- **Humans never manually fill epistemic assessments** (they're always generated by AI/Sentinel)

---

## Solution: JSON-First Default

### Before (Backwards)
```bash
# Defaults to human-readable output (designed for humans)
$ empirica preflight "my task"
# ‚ö†Ô∏è Hangs waiting for input - bad for automation

# Required flag to get machine-readable output
$ empirica preflight "my task" --json
# Returns JSON (for piping/composition)
```

### After (Correct)
```bash
# Defaults to JSON (for AI‚ÜíCLI‚Üístorage composition)
$ empirica preflight "my task"
# Returns JSON immediately (no waiting)

# For inspection/debugging: explicit human flag
$ empirica preflight "my task" --output human
# Shows formatted output for human inspection

# For Sentinel routing: explicit flag (future)
$ empirica preflight "my task" --sentinel
# Routes to Sentinel for interactive decision-making
```

---

## Changes Made

### 1. PREFLIGHT Command (`empirica preflight`)

**Before:**
```python
--output choices=['default', 'json'], default='default'
--json action='store_const'
```

**After:**
```python
--output choices=['human', 'json'], default='json'
--sentinel action='store_true'
--compact action='store_true' (human format only)
--kv action='store_true' (human format only)
--verbose action='store_true' (human format only)
```

**Help text updated:**
- `--output`: "Output format (default: json for programmatic use; --output human for inspection)"
- `--sentinel`: "Route to Sentinel for interactive decision-making (future: Sentinel assessment routing)"

### 2. POSTFLIGHT Command (`empirica postflight`)

**Same changes as preflight:**
```python
--output choices=['human', 'json'], default='json'
--sentinel action='store_true'
```

### 3. Handler Logic (`cascade_commands.py`)

**Before:**
```python
output_format = getattr(args, 'output_format', None) or getattr(args, 'output', 'default')
json_output = output_format == 'json' or getattr(args, 'json', False)
```

**After:**
```python
# Default is JSON for programmatic use (AI‚ÜíCLI‚Üístorage)
# --output human for inspection/debugging
output_format = getattr(args, 'output_format', None) or getattr(args, 'output', 'json')
json_output = output_format == 'json' or getattr(args, 'json', False)
human_output = output_format == 'human'
```

---

## Usage Examples

### AI / Programmatic Use (Default)
```bash
# Returns JSON immediately, no waiting
$ empirica preflight "Investigate API endpoints" \
  --assessment-json '{"engagement": 0.85, "know": 0.40, ...}'

# Output:
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "task": "Investigate API endpoints",
  "timestamp": "2025-12-10T...",
  "vectors": { "engagement": 0.85, "know": 0.40, ... },
  "recommendation": { "action": "proceed", ... }
}

# Pipe to file or next command
$ empirica preflight ... | jq '.session_id' > session.txt
```

### Sentinel Routing (Future)
```bash
# Route to Sentinel for interactive phase selection
$ empirica preflight "task" --sentinel
# (Currently: "Sentinel integration not yet implemented")
```

### Inspection / Debugging
```bash
# Show human-friendly output for inspection
$ empirica preflight "task" --assessment-json '...' --output human

# Output:
üìä Epistemic Vectors:
  üèõÔ∏è  TIER 1: Foundation (35% weight)
    ENGAGEMENT: 0.85 (excellent)
    KNOW: 0.40 (low)
    DO: 0.50 (moderate)
    CONTEXT: 0.80 (good)

  [... more tiers ...]

üí° Recommendation: INVESTIGATE_FIRST (confidence 0.65, threshold 0.70)
```

### Compact / Key-Value Formats
```bash
# Single-line key=value (debugging)
$ empirica preflight "task" --assessment-json '...' --compact
# SESSION=550e8400... ENGAGEMENT=0.85 KNOW=0.40 DO=0.50 ...

# Multi-line key=value
$ empirica preflight "task" --assessment-json '...' --kv
# session_id=550e8400...
# engagement=0.85
# know=0.40
# [... etc ...]
```

---

## Design Rationale

### Why JSON Default?

1. **AI and Sentinel are primary users**
   - They need machine-readable output for composition
   - They never need human-friendly formatting

2. **Programmatic composition requires JSON**
   - AI: `empirica preflight "task" | jq '.session_id'`
   - Sentinel: Parse JSON to route to CHECK/POSTFLIGHT
   - Storage: JSON‚Üígit‚ÜíSQLite pipeline

3. **Human inspection is secondary**
   - Use `--output human` when debugging
   - Shows formatted output for understanding
   - Not the primary flow

### Why `--sentinel` Not `--interactive`?

1. **Clarity about purpose**
   - `--interactive` implies humans will input assessments (false)
   - `--sentinel` clarifies: this is for Sentinel routing

2. **Future extensibility**
   - `--sentinel`: Routes to Sentinel decision system
   - `--output human`: Inspection format (separate concern)
   - These are independent flags

3. **Prevents confusion**
   - Users won't think they should manually fill assessments
   - Sentinel integration becomes clearer

---

## Backward Compatibility

‚ö†Ô∏è **Breaking change for human CLI users** (none exist currently):
- `--json` still works (deprecated, sets output_format)
- `default='json'` means old scripts defaulting to human output will now get JSON
- No known human users (all assessments are AI-generated)

‚úÖ **Compatible with existing code:**
- `--output json` still works
- `--assessment-json` unchanged
- `--prompt-only` unchanged

---

## Testing

```bash
# Verify syntax
python -m py_compile empirica/cli/cli_core.py empirica/cli/command_handlers/cascade_commands.py
# ‚úÖ Syntax valid

# Test default (JSON)
empirica preflight "test" --prompt-only
# ‚Üí Returns JSON prompt

# Test human output
empirica preflight "test" --output human --prompt-only
# ‚Üí Would show human format (if implementation included)

# Test Sentinel flag exists
empirica preflight --help | grep sentinel
# ‚Üí Shows --sentinel flag
```

---

## Next Steps

1. ‚úÖ **CLI argument defaults changed**
2. ‚úÖ **Handler logic updated**
3. ‚úÖ **Syntax verified**
4. **Sentinel implementation** (future: phase routing)
5. **Update documentation** (usage examples)

---

## Impact on Empirica Ecosystem

- **Phase 1 (Git):** JSON output feeds git checkpoint pipeline ‚úÖ
- **Phase 2 (Signing):** JSON‚Üísigned state for Ed25519 audit ‚úÖ
- **Phase 5 (Qdrant):** JSON vectors‚Üísemantic indexing ‚úÖ
- **Phase 6 (Multi-AI):** JSON output‚Üínoema handoff ‚úÖ

This change makes the CLI fit naturally into the composition pipeline instead of fighting against it.
